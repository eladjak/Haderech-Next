#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 מתחיל בדיקות לפני commit..."

# בדיקת פורמט
echo "✨ בודק פורמט קוד..."
pnpm run format || {
  echo "❌ בדיקת פורמט נכשלה. מריץ פורמט אוטומטי..."
  pnpm run format:fix
  echo "✅ פורמט הקוד תוקן. אנא הוסף את השינויים ונסה שוב."
  exit 1
}

# בדיקת טיפוסים
echo "📝 בודק טיפוסים..."
pnpm run type-check || {
  echo "❌ בדיקת טיפוסים נכשלה. אנא תקן את השגיאות:"
  exit 1
}

# בדיקת לינטינג מחמירה
echo "🔍 בודק לינטינג..."
pnpm run lint:strict || {
  echo "❌ בדיקת לינטינג נכשלה. מנסה לתקן אוטומטית..."
  pnpm run lint:fix
  
  # בדיקה חוזרת אחרי תיקון אוטומטי
  pnpm run lint:strict || {
    echo "❌ עדיין יש שגיאות לינטינג. אנא תקן ידנית:"
    exit 1
  }
}

# בדיקת טסטים
echo "🧪 מריץ טסטים..."
pnpm run test || {
  echo "❌ הטסטים נכשלו. אנא תקן את הטסטים הנכשלים:"
  exit 1
}

# בדיקת בנייה
echo "🏗 בודק תהליך בנייה..."
pnpm run build || {
  echo "❌ תהליך הבנייה נכשל. אנא תקן את השגיאות:"
  exit 1
}

# בדיקת גודל חבילה
echo "📦 בודק גודל חבילה..."
pnpm run analyze || {
  echo "⚠️ נמצאו חבילות גדולות. שקול לבצע אופטימיזציה."
}

# בדיקת תלויות מיותרות
echo "🔍 בודק תלויות מיותרות..."
pnpm run depcheck || {
  echo "⚠️ נמצאו תלויות שאינן בשימוש. שקול להסיר אותן."
}

# בדיקת אבטחה
echo "🔒 בודק בעיות אבטחה..."
pnpm audit || {
  echo "⚠️ נמצאו בעיות אבטחה. אנא בדוק את הדוח ועדכן חבילות בהתאם."
}

# בדיקת נגישות
echo "♿ בודק נגישות..."
pnpm run test:a11y || {
  echo "⚠️ נמצאו בעיות נגישות. אנא תקן אותן לפני הדחיפה."
}

# בדיקת ביצועים
echo "⚡ בודק ביצועים..."
pnpm run lighthouse || {
  echo "⚠️ ציון הביצועים נמוך מהמצופה. שקול לבצע אופטימיזציות."
}

# בדיקת קבצים גדולים
echo "📏 בודק גודל קבצים..."
find . -type f -size +5M ! -path "./node_modules/*" ! -path "./.git/*" | while read -r file; do
  echo "⚠️ אזהרה: הקובץ $file גדול מ-5MB"
done

# בדיקת סודות
echo "🔑 בודק קבצי תצורה עבור סודות..."
if grep -r "API_KEY\|SECRET\|PASSWORD\|TOKEN" --exclude-dir={node_modules,.git,dist,.next} .; then
  echo "⚠️ נמצאו סודות פוטנציאליים בקוד. אנא העבר אותם לקובץ .env"
  exit 1
fi

echo "✅ כל הבדיקות עברו בהצלחה! 🎉"
